version: 0.2

phases:
  install:
    runtime-versions:
      nodejs: 18
    commands:
      - echo Installing dependencies...
      - npm ci
      - echo Installing Playwright browsers...
      - npx playwright install --with-deps
      - echo Installing jq for Slack notification...
      - apt-get update && apt-get install -y jq

  build:
    commands:
      - echo Starting Playwright tests...
      - |
        npx playwright test --reporter=html > result.txt || true

      - echo Fetching Slack webhook from Secrets Manager...
      - |
        export SLACK_WEBHOOK=$(aws secretsmanager get-secret-value \
          --secret-id SlackPlaywrightWebhook \
          --query SecretString \
          --output text | jq -r '.SLACK_WEBHOOK_URL')

      - echo Preparing Slack message...
      - |
        export SUMMARY=$(tail -n 20 result.txt | sed 's/"/\\"/g')
        export SLACK_MESSAGE="{\"text\":\":robot_face: *Playwright Test Report*\n\`\`\`${SUMMARY}\`\`\`\"}"

      - echo Sending Slack notification...
      - |
        curl -X POST -H 'Content-type: application/json' \
          --data "$SLACK_MESSAGE" $SLACK_WEBHOOK

artifacts:
  files:
    - '**/*'
  base-directory: playwright-report
  discard-paths: no
